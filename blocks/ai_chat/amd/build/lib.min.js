define("block_ai_chat/lib",["exports","core/modal_factory","core/modal_events"],(function(_exports,Modal,ModalEvents){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,Modal=_interopRequireWildcard(Modal),ModalEvents=_interopRequireWildcard(ModalEvents);var questionString="Can I help u...",errorString="An error occurred! Please try again later.";_exports.init=data=>{const blockId=data.blockId,history=data.history;console.log("hehehehe");for(let message of history)console.log("His: ",message),addToChatLog(1===message.role?"user":"bot",message.content,1);window.addEventListener("resize",(event=>{event.stopImmediatePropagation()}),!0),document.querySelector("#ai_input").addEventListener("keyup",(e=>{13===e.which&&""!==e.target.value&&(addToChatLog("user",e.target.value,0),createCompletion(e.target.value,blockId),e.target.value="")})),document.querySelector(".block_ai_chat #go").addEventListener("click",(e=>{const input=document.querySelector("#ai_input");""!==input.value&&(addToChatLog("user",input.value,0),createCompletion(input.value,blockId),input.value="")})),document.querySelector(".block_ai_chat #refresh").addEventListener("click",(e=>{e.preventDefault(),Modal.create({type:Modal.types.SAVE_CANCEL,title:"Confirmation before refresh",body:"<p>Are you sure before you choose to refresh this chat?</p>"}).then((modal=>{modal.show(),modal.getRoot().on(ModalEvents.save,(()=>{console.log("Click save"),clearHistory(blockId),console.log("save successful!"),modal.hide()})),modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()}))})).catch(Notification.exception)})),require(["core/str"],(function(str){str.get_strings([{key:"askaquestion",component:"block_ai_chat"},{key:"erroroccurred",component:"block_ai_chat"}]).then((results=>{questionString=results[0],errorString=results[1]}))}))};const addToChatLog=(type,message,his)=>{console.log("Message begin addtochatlog",message);let messageContainer=document.querySelector("#ai_chat_log");const messageElem=document.createElement("div");messageElem.classList.add("ai_message");for(let className of type.split(" "))messageElem.classList.add(className);const messageText=document.createElement("span");his?messageText.innerText=message:messageText.innerHTML=message,messageElem.append(messageText),console.log(messageText),messageContainer.append(messageElem),messageText.offsetWidth&&(messageElem.style.width=messageText.offsetWidth+40+"px"),messageContainer.scrollTop=messageContainer.scrollHeight},clearHistory=blockId=>{fetch("".concat(M.cfg.wwwroot,"/blocks/ai_chat/api/completion.php?block_id=").concat(blockId),{method:"DELETE"}).then((response=>{try{if(response.ok)return void(document.querySelector("#ai_chat_log").innerHTML="");throw Error(response.statusText)}catch{console.log(error)}})).catch((error=>{console.log(error),document.querySelector("#ai_input").classList.add("error"),document.querySelector("#ai_input").placeholder=errorString}))},createCompletion=(message,blockId)=>{document.querySelector(".block_ai_chat #control_bar").classList.add("disabled"),document.querySelector("#ai_input").classList.remove("error"),document.querySelector("#ai_input").placeholder=questionString,document.querySelector("#ai_input").blur(),addToChatLog("bot loading","...",0),fetch("".concat(M.cfg.wwwroot,"/blocks/ai_chat/api/completion.php"),{method:"POST",body:JSON.stringify({message:message,blockId:blockId})}).then((response=>{let messageContainer=document.querySelector("#ai_chat_log");if(messageContainer.removeChild(messageContainer.lastElementChild),document.querySelector(".block_ai_chat #control_bar").classList.remove("disabled"),console.log("response: ",response),response.ok)return response.json();throw Error(response.statusText)})).then((data=>{console.log("data: ",data);try{addToChatLog("bot",data.message,0)}catch(error){console.log(error)}document.querySelector("#ai_input").focus()})).catch((error=>{document.querySelector("#ai_input").classList.add("error"),document.querySelector("#ai_input").placeholder=errorString}))}}));

//# sourceMappingURL=lib.min.js.map